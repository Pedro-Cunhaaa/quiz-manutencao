<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Treinamento - Painel</title>
    <style>
        html,
        body {
            min-height: 100%;
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f7f6;
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        body.modo-admin {
            justify-content: flex-start;
            padding-top: 40px;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        .container-admin {
            max-width: 1250px;
        }

        .escondido {
            display: none;
        }

        .grid-manutencao {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            text-align: left;
            margin-top: 20px;
            align-items: start;
        }

        @media (max-width: 1000px) {
            .grid-manutencao {
                grid-template-columns: 1fr;
            }
        }

        .card-admin {
            background: #34495e;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: left;
            border-left: 5px solid #3498db;
            position: relative;
        }

        .detalhes-expansiveis {
            background: #fdfdfd;
            color: #333;
            margin-top: 10px;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            font-size: 13px;
            max-height: 350px;
            overflow-y: auto;
        }

        .opcao {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            color: white;
            transition: 0.3s;
            font-size: 14px;
            font-weight: bold;
        }

        .input-edit {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }

        .coluna-titulo {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 18px;
        }

        .correto {
            color: #27ae60;
            font-weight: bold;
        }

        .errado {
            color: #e74c3c;
            font-weight: bold;
        }

        .btn-excluir-rel {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            width: 22px;
            height: 22px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .form-sugestao {
            text-align: left;
            margin-top: 20px;
            background: #eee;
            padding: 15px;
            border-radius: 8px;
            color: #333;
        }

        .linha-alternativa {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .footer-creditos {
            margin-top: 25px;
            font-size: 14px;
            color: #2b2f30;
            border-top: 1px solid #eee;
            padding-top: 15px;
            font-style: sans-serif;
        }

        .data-badge {
            font-size: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .area-criacao {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed #d35400;
            margin-bottom: 20px;
            color: #333;
        }
    </style>
</head>

<body>
    <div id="main-container" class="container">
        <div id="tela-login">
            <h2>Entrar no Sistema</h2>
            <input type="text" id="user" placeholder="Usu√°rio" class="input-edit">
            <input type="password" id="pass" placeholder="Senha" class="input-edit">
            <button onclick="fazerLogin()" class="opcao" style="background: #27ae60;">Acessar</button>
        </div>

        <div id="tela-menu" class="escondido">
            <h2 id="boas-vindas">Bem-vindo</h2>
            <button onclick="iniciarQuiz()" class="opcao" style="background:#e67e22; font-size:20px; padding:20px;">Iniciar Quiz</button>
            <button onclick="location.reload()" class="opcao" style="background: #7f8c8d;">Sair</button>
        </div>

        <div id="tela-quiz" class="escondido">
            <div id="timer" style="font-size: 40px; color: red;">30</div>
            <h3 id="texto-pergunta"></h3>
            <div id="area-opcoes"></div>
        </div>

        <div id="tela-resultados" class="escondido">
            <h2 id="titulo-resultados">Painel de Controle</h2>
            <div id="layout-admin"></div>
            <button onclick="location.reload()" class="opcao" style="background: #7f8c8d; max-width: 200px; margin: 20px auto;">Sair do Painel (Logout)</button>
        </div>

        <div class="footer-creditos">Script by Mateus Martins, Pedro Brochi e Wagner Cunha</div>
    </div>

    <script>
        const Utils = {
            // Transforma o arquivo selecionado em uma string Base64
            toBase64: (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            }),

            // Mostra uma pr√©via da imagem ao selecionar
            preview: (input) => {
                const img = document.getElementById('preview-img');
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        img.src = e.target.result;
                        img.style.display = 'block';
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }
        };

        let perguntas = [],
            indiceAtual = 0,
            respostasUsuario = {},
            cronometro, tempoRestante = 30;
        let usuarioLogado = "",
            historicoAdmin = [],
            ideiasAtuais = [],
            listaUsuarios = [];

        async function atualizarDadosInterface() {
            try {
                const res = await fetch('/admin/refresh-dados');
                const dados = await res.json();

                // 1. Sincroniza√ß√£o de Vari√°veis Globais
                historicoAdmin = dados.tentativas;
                ideiasAtuais = dados.ideiasAtuais;
                listaUsuarios = dados.listaUsuarios;
                
                // Garante que o Banco Geral e as Quest√µes Ativas sejam atualizados
                // Certifique-se de que essas vari√°veis globais (questoesBanco e perguntasAtuais) 
                // sejam as mesmas usadas em todo o seu script.
                if (dados.bancoGeral) {
                    questoesBanco = dados.bancoGeral; 
                }
                if (dados.perguntasQuiz) {
                    perguntasAtuais = dados.perguntasQuiz;
                }

                // 2. Renderiza√ß√£o Condicional (Interface da Manuten√ß√£o)
                if (usuarioLogado === "manutencao") {
                    renderUsuarios();
                    renderSugestoes(); // Esta fun√ß√£o agora j√° mostra fotos
                    
                    // Atualiza as listas de quest√µes apenas se a se√ß√£o n√£o estiver escondida
                    const secQuestoes = document.getElementById('sec-questoes');
                    const secBanco = document.getElementById('sec-banco-geral');

                    if (secQuestoes && !secQuestoes.classList.contains('escondido')) {
                        renderQuestoesAtuais(perguntasAtuais); // Chama a fun√ß√£o com foto
                    }
                    
                    if (secBanco && !secBanco.classList.contains('escondido')) {
                        renderBanco(questoesBanco); // Chama a fun√ß√£o com foto
                    }
                }
                
                // 3. Relat√≥rios (Sempre atualiza para ambos os usu√°rios)
                renderRelatorios('render-relatorios');

            } catch (err) {
                console.error("Erro ao sincronizar dados:", err);
            }
        }

        function renderQuestoesAtuais(questoes) {
            const div = document.getElementById('render-questoes-atuais');
            if (!div) return;

            div.innerHTML = questoes.map((q, i) => `
                <div class="card-admin" style="background:#34495e; position: relative; border-left: 4px solid #3498db;">
                    <button class="btn-excluir-rel" onclick="removerDoQuiz(${q.id})" 
                            style="position:absolute; top:5px; right:5px; background:#e74c3c; border-radius:4px; border:none; color:white; cursor:pointer; width:22px; height:22px; font-weight:bold;">X</button>
                    
                    <strong>Quest√£o ${i + 1}</strong>

                    ${q.imagem ? `
                        <div style="background:white; border-radius:4px; padding:5px; margin:10px 0; text-align:center;">
                            <img src="${q.imagem}" style="width:100%; max-height:120px; object-fit:contain; display:block; margin:0 auto;">
                        </div>
                    ` : ''}
                    
                    <p style="margin:5px 0; font-weight:bold;">${q.pergunta}</p>
                    <div style="font-size:12px; color:#bdc3c7;">
                        ${q.opcoes.map(o => `
                            <div style="${o === q.correta ? 'color:#2ecc71;' : ''}">
                                ${o === q.correta ? '[X]' : '[ ]'} ${o}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('') || "Nenhuma quest√£o ativa.";
        }

        async function fazerLogin() {
            const uInput = document.getElementById('user').value.toLowerCase();
            const sInput = document.getElementById('pass').value;
            const res = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuario: uInput, senha: sInput })
            });
            const dados = await res.json();

            if (dados.sucesso) {
                usuarioLogado = uInput;
                document.getElementById('tela-login').classList.add('escondido');
                if (dados.tipo === "admin") {
                    document.body.classList.add('modo-admin');
                    historicoAdmin = dados.tentativas;
                    ideiasAtuais = dados.ideiasAtuais;
                    listaUsuarios = dados.listaUsuarios;
                    configurarTelaAdmin();
                } else {
                    perguntas = dados.perguntas;
                    document.getElementById('boas-vindas').innerText = `Ol√°, ${usuarioLogado.toUpperCase()}`;
                    document.getElementById('tela-menu').classList.remove('escondido');
                }
            } else {
                alert("Login incorreto.");
            }
        }

        function configurarTelaAdmin() {
            const container = document.getElementById('main-container');
            const layout = document.getElementById('layout-admin');
            document.getElementById('tela-resultados').classList.remove('escondido');

            if (usuarioLogado === "manutencao") {
                container.classList.add('container-admin');
                layout.innerHTML = `
                <div class="grid-manutencao">
                    <div class="coluna">
                        <button onclick="toggleSecao('sec-users', this, 'Usuarios')" class="opcao" style="background: #9b59b6;">Exibir Usu√°rios</button>
                        <div id="sec-users" class="escondido">
                            <div class="coluna-titulo">Usu√°rios</div>
                            <div id="render-usuarios"></div>
                            <div style="background:#eee; padding:10px; border-radius:8px; color:#333">
                                <input id="n-user" class="input-edit" placeholder="Login">
                                <input id="n-pass" class="input-edit" placeholder="Senha">
                                <select id="n-tipo" class="input-edit">
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                                <button onclick="addUsuario()" class="opcao" style="background:#27ae60; padding:5px;">Adicionar</button>
                            </div>
                        </div>
                        <button onclick="toggleSecaoQuestoes('sec-questoes', this)" class="opcao" style="background: #e67e22; margin-top:15px;">Exibir Quest√µes do Quiz</button>
                        <div id="sec-questoes" class="escondido">
                            <div class="coluna-titulo">Quest√µes Atuais</div>
                            <div id="render-questoes-atuais"></div>
                        </div>
                    </div>

                    <div class="coluna">
                        <button onclick="toggleSecao('sec-rel', this, 'Relatorios')" class="opcao" style="background: #3498db;">Exibir Relat√≥rios</button>
                        <div id="sec-rel" class="escondido">
                            <div class="coluna-titulo">Relatorios</div>
                            <div id="render-relatorios"></div>
                        </div>
                        <button onclick="toggleSecaoBanco('sec-banco-geral', this)" class="opcao" style="background: #d35400; margin-top:15px;">Banco de Quest√µes</button>
                        <div id="sec-banco-geral" class="escondido">
                            <div class="coluna-titulo">Banco Geral de Quest√µes</div>
                            <button onclick="toggleSecao('area-nova-questao', this, 'Criar Quest√£o')" class="opcao" style="background:#e67e22; font-size:12px;">Criar Quest√£o</button>
                            
                            <div id="area-nova-questao" class="escondido area-criacao">
                                <strong>Nova Quest√£o (Direta no Banco)</strong>
                                <input type="text" id="admin-pergunta" class="input-edit" placeholder="Pergunta">
                                
                                <label style="display:block; margin-top:10px; font-size:12px;">Foto (Opcional):</label>
                                <div style="position: relative;">
                                    <input type="file" id="input-foto-admin" class="input-edit" accept="image/*" onchange="gerenciarPreview(this, 'preview-admin', 'btn-del-admin')">
                                    <img id="preview-admin" style="display:none; width:100%; max-height:150px; object-fit:contain; margin-top:10px; border-radius:4px;">
                                    <button id="btn-del-admin" type="button" onclick="removerFoto('input-foto-admin', 'preview-admin', 'btn-del-admin')" 
                                        style="display:none; position: absolute; top: 45px; right: 5px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer;">X</button>
                                </div>

                                <div class="linha-alternativa"><input type="radio" name="correta-admin" value="0"> <input type="text" id="admin-opt-0" class="input-edit" placeholder="Alternativa 1"></div>
                                <div class="linha-alternativa"><input type="radio" name="correta-admin" value="1"> <input type="text" id="admin-opt-1" class="input-edit" placeholder="Alternativa 2"></div>
                                <div class="linha-alternativa"><input type="radio" name="correta-admin" value="2"> <input type="text" id="admin-opt-2" class="input-edit" placeholder="Alternativa 3"></div>
                                <div class="linha-alternativa"><input type="radio" name="correta-admin" value="3"> <input type="text" id="admin-opt-3" class="input-edit" placeholder="Alternativa 4"></div>
                                <div class="linha-alternativa"><input type="radio" name="correta-admin" value="4"> <input type="text" id="admin-opt-4" class="input-edit" placeholder="Alternativa 5"></div>
                                
                                <button onclick="salvarQuestao('admin')" class="opcao" style="background: #27ae60;">Salvar no Banco</button>
                            </div>
                            <div id="render-banco-geral"></div>
                        </div>
                    </div>

                    <div class="coluna">
                        <button onclick="toggleSecao('sec-sug', this, 'Sugestoes')" class="opcao" style="background: #27ae60;">Exibir Sugest√µes</button>
                        <div id="sec-sug" class="escondido">
                            <div class="coluna-titulo">Sugest√µes</div>
                            <div id="render-sugestoes"></div>
                        </div>
                    </div>
                </div>`;
                renderUsuarios();
                renderRelatorios('render-relatorios');
                renderSugestoes();
            } else {
                // Bloco para Mateus (j√° ajustado anteriormente)
                layout.innerHTML = `
                <button onclick="toggleSecao('sec-rel-mat', this, 'Relat√≥rios')" class="opcao" style="background: #3498db;">Exibir Relat√≥rios</button>
                <div id="sec-rel-mat" class="escondido"><div id="render-relatorios"></div></div>
                
                <div class="form-sugestao">
                    <div class="coluna-titulo" style="font-size:14px;">Sugerir Nova Quest√£o</div>
                    <input type="text" id="sug-pergunta" class="input-edit" placeholder="Pergunta">
                    
                    <label style="display:block; margin-top:10px; font-size:12px;">Foto (Opcional):</label>
                    <div style="position: relative;">
                        <input type="file" id="input-foto-sug" class="input-edit" accept="image/*" onchange="gerenciarPreview(this, 'preview-sug', 'btn-del-sug')">
                        <img id="preview-sug" style="display:none; width:100%; max-height:150px; object-fit:contain; margin-top:10px; border-radius:4px;">
                        <button id="btn-del-sug" type="button" onclick="removerFoto('input-foto-sug', 'preview-sug', 'btn-del-sug')" 
                            style="display:none; position: absolute; top: 45px; right: 5px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer;">X</button>
                    </div>

                    <div class="linha-alternativa"><input type="radio" name="correta-sug" value="0"> <input type="text" id="opt-sug-0" class="input-edit" placeholder="Alternativa 1"></div>
                    <div class="linha-alternativa"><input type="radio" name="correta-sug" value="1"> <input type="text" id="opt-sug-1" class="input-edit" placeholder="Alternativa 2"></div>
                    <div class="linha-alternativa"><input type="radio" name="correta-sug" value="2"> <input type="text" id="opt-sug-2" class="input-edit" placeholder="Alternativa 3"></div>
                    <div class="linha-alternativa"><input type="radio" name="correta-sug" value="3"> <input type="text" id="opt-sug-3" class="input-edit" placeholder="Alternativa 4"></div>
                    <div class="linha-alternativa"><input type="radio" name="correta-sug" value="4"> <input type="text" id="opt-sug-4" class="input-edit" placeholder="Alternativa 5"></div>
                    
                    <button onclick="salvarQuestao('sugestao')" class="opcao" style="background: #27ae60;">Enviar Sugest√£o</button>
                </div>`;
                renderRelatorios('render-relatorios');
            }
        }

        async function salvarQuestao(tipo) {
            // 1. Identifica√ß√£o Din√¢mica de Prefixo e IDs
            // Verificamos qual campo de pergunta existe na tela no momento
            const perguntaElem = document.getElementById('admin-pergunta') || 
                                document.getElementById('sug-pergunta') || 
                                document.getElementById('dir-pergunta');
            
            // Verificamos qual input de foto est√° dispon√≠vel
            const fotoInput = document.getElementById('input-foto-admin') || 
                            document.getElementById('input-foto-sug') || 
                            document.getElementById('input-foto');

            // Identificamos o prefixo para os Radio Buttons e Op√ß√µes
            // Se existir o campo de pergunta da manuten√ß√£o, usamos 'admin', caso contr√°rio 'sug'
            const prefixo = (perguntaElem && perguntaElem.id.includes('admin')) ? 'admin' : 'sug';

            // Captura o radio marcado (tenta todos os nomes poss√≠veis para evitar erro de null)
            const corretaRadio = document.querySelector(`input[name="correta-${prefixo}"]:checked`) || 
                                document.querySelector(`input[name="correta-sug"]:checked`) || 
                                document.querySelector(`input[name="correta-dir"]:checked`);

            // Valida√ß√£o de seguran√ßa
            if (!perguntaElem || !corretaRadio) {
                return alert("Erro: Por favor, preencha a pergunta e selecione a alternativa correta.");
            }

            const pergunta = perguntaElem.value;
            const indiceCorreta = corretaRadio.value;
            
            // 2. Identifica√ß√£o Din√¢mica da Base das Op√ß√µes (Evita o erro de leitura de 'value' em null)
            let optIdBase;
            if (document.getElementById('admin-opt-0')) {
                optIdBase = 'admin-opt-';
            } else if (document.getElementById('opt-sug-0')) {
                optIdBase = 'opt-sug-';
            } else {
                optIdBase = 'opt-'; // Fallback para IDs antigos
            }

            const textoCorretaElem = document.getElementById(`${optIdBase}${indiceCorreta}`) || 
                                    document.getElementById(`dir-opt-${indiceCorreta}`);
            
            if (!textoCorretaElem) return alert("Erro ao encontrar o texto da alternativa selecionada.");
            const textoCorreta = textoCorretaElem.value;

            // 3. Processamento da Imagem
            let imagemBase64 = null;
            if (fotoInput && fotoInput.files[0]) {
                imagemBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(fotoInput.files[0]);
                });
            }

            // 4. Montagem do Objeto (Payload)
            const payload = {
                id: Date.now(),
                pergunta: pergunta,
                imagem: imagemBase64,
                opcoes: [],
                correta: textoCorreta
            };

            const camposOpcoes = [];
            for (let i = 0; i < 5; i++) {
                const opt = document.getElementById(`${optIdBase}${i}`) || 
                            document.getElementById(`dir-opt-${i}`) || 
                            document.getElementById(`opt-sug-${i}`);
                if (opt) {
                    payload.opcoes.push(opt.value);
                    camposOpcoes.push(opt);
                }
            }

            // 5. Envio para o Servidor
            const rota = tipo === 'admin' ? '/questoes/adicionar' : '/salvar-ideia';

            try {
                const res = await fetch(rota, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    alert("Sucesso!");
                    
                    // Atualiza interface sem recarregar (Mant√©m login)
                    await atualizarDadosInterface(); 

                    // Limpeza dos campos
                    perguntaElem.value = '';
                    if (fotoInput) fotoInput.value = '';
                    camposOpcoes.forEach(campo => campo.value = '');
                    corretaRadio.checked = false;

                    if (typeof voltarMenu === 'function') {
                        voltarMenu();
                    }
                } else {
                    alert("Erro ao salvar no servidor. Verifique se a rota existe.");
                }
            } catch (err) {
                console.error("Erro na requisi√ß√£o:", err);
                alert("Erro de conex√£o com o servidor.");
            }
        }

        function renderRelatorios(id) {
            const divAlvo = document.getElementById(id);
            if (!divAlvo) return;
            const ordenado = [...historicoAdmin].reverse();

            let htmlDownload = ordenado.length > 0 ?
                `<button onclick="baixarRelatoriosTXT()" class="opcao" style="background: #16a085; margin-bottom: 15px;">üì• Baixar Relat√≥rios (.txt)</button>` : '';

            divAlvo.innerHTML = htmlDownload + ordenado.map((t, i) => {
                const indexOriginal = historicoAdmin.length - 1 - i;
                return `
                <div class="card-admin">
                    ${usuarioLogado === 'manutencao' ? `<button class="btn-excluir-rel" onclick="removerRelatorio(${indexOriginal})">X</button>` : ''}
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <strong>${t.nome.toUpperCase()}</strong>
                        <span class="data-badge">${t.data}</span>
                    </div>
                    <div>Nota: <span style="color:#f1c40f;">${t.nota}</span></div>
                    <button onclick="toggleSecao('det-${indexOriginal}', this, 'Detalhes')" class="opcao" style="padding:5px; font-size:11px; margin-top:8px; background:#2980b9;">Ver Detalhes</button>
                    
                    <div id="det-${indexOriginal}" class="escondido detalhes-expansiveis">
                        ${t.detalhes.map(d => `
                            <div style="margin-bottom:12px; border-bottom: 1px solid #444; padding-bottom: 8px;">
                                <strong>P: ${d.pergunta}</strong><br>
                                
                                ${d.imagem ? `
                                    <div style="margin: 8px 0; text-align: center; background: white; border-radius: 4px; padding: 5px;">
                                        <img src="${d.imagem}" style="max-width: 100%; max-height: 120px; object-fit: contain; cursor: pointer;" onclick="window.open(this.src)">
                                    </div>
                                ` : ''}

                                <div style="font-size: 13px; margin-top: 5px;">
                                    Resp. Dada: <span class="${d.status ? 'correto' : 'errado'}">
                                        ${d.respostaDada} ${d.status ? '(Certa)' : '(Errada)'}
                                    </span>
                                    ${!d.status ? `<br><span style="color: #2ecc71;">Correta: ${d.correta || 'N√£o registrada'}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }).join('') || "Sem relat√≥rios.";
        }

        function baixarRelatoriosTXT() {
            if (historicoAdmin.length === 0) return alert("N√£o h√° relat√≥rios para baixar.");

            let conteudo = "RELAT√ìRIO DE DESEMPENHO - SISTEMA DE MANUTEN√á√ÉO\n";
            conteudo += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n`;
            conteudo += "================================================\n\n";

            [...historicoAdmin].reverse().forEach(rel => {
                conteudo += `USU√ÅRIO: ${rel.nome.toUpperCase()}\n`;
                conteudo += `DATA:    ${rel.data}\n`;
                conteudo += `NOTA:    ${rel.nota}\n`;
                conteudo += `DETALHES DAS RESPOSTAS:\n`;

                rel.detalhes.forEach((det, index) => {
                    const marcadorImagem = det.imagem ? " [IMAGEM PRESENTE NO QUIZ]" : "";
                    conteudo += ` ${index + 1}. P: ${det.pergunta}${marcadorImagem}\n`;
                    conteudo += `    Resposta Dada: ${det.respostaDada}\n`;
                    conteudo += `    Status: [${det.status ? 'CORRETA' : 'ERRADA'}]\n`;
                    
                    // Se estiver errada, adiciona o gabarito no texto
                    if (!det.status) {
                        conteudo += `    Gabarito: ${det.correta || 'N√£o informado'}\n`;
                    }
                    conteudo += `\n`;
                });

                conteudo += "------------------------------------------------\n\n";
            });

            const blob = new Blob([conteudo], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            
            // Nome do arquivo com data e hora para evitar sobreposi√ß√£o
            const dataArquivo = new Date().toISOString().slice(0, 10);
            link.download = `Relatorios_Manutencao_${dataArquivo}.txt`;
            
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function renderUsuarios() {
            const div = document.getElementById('render-usuarios');
            if (!div) return;
            div.innerHTML = listaUsuarios.map((u, i) => {
                const isManutencao = u.login === "manutencao";
                return `
                <div class="card-admin" style="background:${isManutencao ? '#2d3436' : '#4b6584'};">
                    <input id="edit-u-${i}" class="input-edit" value="${u.login}" ${isManutencao ? 'disabled' : ''}>
                    <input id="edit-p-${i}" class="input-edit" value="${u.senha}">
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button onclick="editUsuario(${i})" style="flex:1; background:#27ae60; border:none; color:white; border-radius:4px; padding:5px; cursor:pointer;">Salvar</button>
                        ${isManutencao ? '' : `<button onclick="delUsuario(${i})" style="flex:1; background:#e74c3c; border:none; color:white; border-radius:4px; padding:5px; cursor:pointer;">Excluir</button>`}
                    </div>
                </div>`;
            }).join('');
        }

        function renderSugestoes() {
            const div = document.getElementById('render-sugestoes');
            if (!div) return;
            div.innerHTML = ideiasAtuais.map((item, i) => `
            <div class="card-admin" style="background:#2c3e50; border-left-color:#27ae60;">
                <strong>Sugest√£o #${i + 1}</strong>
                
                ${item.imagem ? `
                    <div style="margin-top:10px; text-align:center; background:white; border-radius:4px; padding:5px;">
                        <img src="${item.imagem}" style="max-width:100%; max-height:150px; object-fit:contain;">
                    </div>
                ` : ''}

                <div style="margin:10px 0; font-size:13px;">
                    <strong>P: ${item.pergunta}</strong><br>
                    ${item.opcoes.map(o => `
                        <div style="${o === item.correta ? 'color:#2ecc71; font-weight:bold;' : ''}">
                            ${o === item.correta ? '[X]' : '[ ]'} ${o}
                        </div>
                    `).join('')}
                </div>
                <button onclick="aprovarParaBanco(${item.id})" class="opcao" style="background:#27ae60; margin-bottom:5px;">Aprovar e Mover para Banco</button>
                <button onclick="excluirSugestao(${item.id})" class="opcao" style="background:#e74c3c;">Excluir</button>
            </div>`).join('') || "Nenhuma sugest√£o pendente.";
        }

        async function aprovarParaBanco(id) {
            try {
                const res = await fetch('/questoes/adicionar-da-sugestao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });

                if (res.ok) {
                    alert("Quest√£o aprovada e enviada ao Banco Geral!");
                    
                    // 1. Atualiza os dados locais (ideiasAtuais, etc) vindo do servidor
                    await atualizarDadosInterface(); 
                    
                    // 2. Renderiza novamente as colunas afetadas
                    renderSugestoes(); 
                    
                    // 3. Se o banco estiver aberto, atualiza ele tamb√©m
                    const secBanco = document.getElementById('sec-banco-geral');
                    if (secBanco && !secBanco.classList.contains('escondido')) {
                        // Chama a fun√ß√£o que busca e renderiza o banco
                        const btnBanco = document.querySelector("button[onclick*='toggleSecaoBanco']");
                        toggleSecaoBanco('sec-banco-geral', btnBanco); 
                    }
                }
            } catch (err) {
                console.error("Erro ao aprovar:", err);
            }
        }

        async function ativarQuestao(id) {
            await fetch('/questoes/ativar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            const btnQuiz = document.querySelector("button[onclick*='toggleSecaoQuestoes']");
            const btnBanco = document.querySelector("button[onclick*='toggleSecaoBanco']");
            document.getElementById('sec-questoes').classList.add('escondido');
            document.getElementById('sec-banco-geral').classList.add('escondido');
            toggleSecaoQuestoes('sec-questoes', btnQuiz);
            toggleSecaoBanco('sec-banco-geral', btnBanco);
        }

        async function removerDoQuiz(id) {
            if (!confirm("Deseja tirar esta quest√£o do Quiz e mov√™-la de volta para o banco geral?")) return;

            try {
                const res = await fetch('/questoes/remover-do-quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });

                if (res.ok) {
                    alert("Quest√£o movida para o banco com sucesso!");

                    // 1. Sincroniza os dados do servidor com as vari√°veis locais (importante!)
                    await atualizarDadosInterface();

                    // 2. Localiza os bot√µes para resetar a visualiza√ß√£o
                    const btnQuiz = document.querySelector("button[onclick*='toggleSecaoQuestoes']");
                    const btnBanco = document.querySelector("button[onclick*='toggleSecaoBanco']");

                    // 3. Reseta as se√ß√µes para for√ßar o redesenho com os novos dados
                    const secQuestoes = document.getElementById('sec-questoes');
                    const secBanco = document.getElementById('sec-banco-geral');

                    if (secQuestoes) {
                        secQuestoes.classList.add('escondido');
                        if (btnQuiz) toggleSecaoQuestoes('sec-questoes', btnQuiz);
                    }

                    if (secBanco) {
                        secBanco.classList.add('escondido');
                        if (btnBanco) toggleSecaoBanco('sec-banco-geral', btnBanco);
                    }
                } else {
                    alert("Erro ao remover quest√£o no servidor.");
                }
            } catch (err) {
                console.error("Erro na requisi√ß√£o:", err);
                alert("Erro de conex√£o.");
            }
        }

        async function excluirDoBanco(id) {
            if (!confirm("Deseja EXCLUIR DEFINITIVAMENTE esta quest√£o do banco?")) return;
            
            try {
                const res = await fetch('/questoes/excluir-do-banco', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });

                if (res.ok) {
                    alert("Quest√£o removida com sucesso!");
                    
                    // Importante: Atualiza os dados globais antes de re-renderizar
                    await atualizarDadosInterface(); 
                    
                    // Fecha e abre a se√ß√£o do banco para atualizar a lista visualmente
                    const btnBanco = document.querySelector("button[onclick*='toggleSecaoBanco']");
                    const secBanco = document.getElementById('sec-banco-geral');
                    
                    if (secBanco) {
                        secBanco.classList.add('escondido');
                        if (btnBanco) toggleSecaoBanco('sec-banco-geral', btnBanco);
                    }
                } else {
                    alert("Erro ao excluir quest√£o do servidor.");
                }
            } catch (err) {
                console.error("Erro na requisi√ß√£o de exclus√£o:", err);
            }
        }

        async function addUsuario() {
            const u = document.getElementById('n-user').value,
                p = document.getElementById('n-pass').value,
                t = document.getElementById('n-tipo').value;
            await fetch('/usuarios/adicionar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login: u.toLowerCase(), senha: p, tipo: t })
            });
            await atualizarDadosInterface();
            document.getElementById('n-user').value = "";
            document.getElementById('n-pass').value = "";
        }

        async function editUsuario(i) {
            const u = document.getElementById(`edit-u-${i}`).value,
                p = document.getElementById(`edit-p-${i}`).value;
            await fetch('/usuarios/editar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    index: i,
                    novoLogin: u.toLowerCase(),
                    novaSenha: p,
                    novoTipo: listaUsuarios[i].tipo
                })
            });
            await atualizarDadosInterface();
            alert("Salvo!");
        }

        async function delUsuario(i) {
            if (!confirm("Excluir?")) return;
            await fetch('/usuarios/excluir', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index: i })
            });
            await atualizarDadosInterface();
        }

        async function excluirSugestao(id) {
            await fetch('/excluir-ideia', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            await atualizarDadosInterface();
        }

        async function removerRelatorio(idx) {
            if (confirm("Tem certeza que deseja apagar este relat√≥rio permanentemente?")) {
                await fetch('/remover-relatorio', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ indexOriginal: idx })
                });
                await atualizarDadosInterface();
            }
        }

        async function toggleSecaoQuestoes(id, btn) {
            const sec = document.getElementById(id);
            
            if (sec.classList.contains('escondido')) {
                try {
                    // Busca as quest√µes atualizadas do servidor
                    const res = await fetch('/questoes/listar');
                    const data = await res.json();
                    
                    // Atualiza a vari√°vel global para manter a sincronia
                    perguntasAtuais = data; 

                    // Chama a fun√ß√£o de renderiza√ß√£o que j√° tem suporte a fotos e [X]
                    renderQuestoesAtuais(data);

                    // Ajustes de interface
                    sec.classList.remove('escondido');
                    btn.innerText = "Ocultar Quest√µes do Quiz";
                    btn.style.background = "#c0392b"; // Opcional: muda cor para indicar que pode fechar
                } catch (err) {
                    console.error("Erro ao carregar quest√µes:", err);
                    alert("N√£o foi poss√≠vel carregar as quest√µes.");
                }
            } else {
                sec.classList.add('escondido');
                btn.innerText = "Exibir Quest√µes do Quiz";
                btn.style.background = "#e67e22"; // Volta para a cor original
            }
        }

        async function toggleSecaoBanco(id, btn) {
            const sec = document.getElementById(id);
            const divRender = document.getElementById('render-banco-geral');
            if (sec.classList.contains('escondido')) {
                const res = await fetch('/questoes/listar-banco');
                const data = await res.json();
                divRender.innerHTML = data.map(q => `
                <div class="card-admin" style="background:#4b6584; border-left-color:#f39c12;">
                    <strong>${q.pergunta}</strong>
                    <div style="font-size:11px; margin-top:5px; opacity:0.8;">
                        ${q.opcoes ? q.opcoes.map(o => `<div>${o === q.correta ? '[X]' : '[ ]'} ${o}</div>`).join('') : ''}
                    </div>
                    <button onclick="ativarQuestao(${q.id})" style="background:#27ae60; color:white; border:none; width:100%; border-radius:4px; padding:8px; margin-top:8px; cursor:pointer; font-weight:bold;">Ativar no Quiz</button>
                    <button onclick="excluirDoBanco(${q.id})" style="background:#e74c3c; color:white; border:none; width:100%; border-radius:4px; padding:5px; margin-top:5px; cursor:pointer; font-size:11px;">Excluir Permanentemente</button>
                </div>`).join('') || "Banco vazio.";
                sec.classList.remove('escondido');
                btn.innerText = "Ocultar Banco de Quest√µes";
            } else {
                sec.classList.add('escondido');
                btn.innerText = "Exibir Banco de Quest√µes";
            }
        }

        function toggleSecao(id, btn, nome) {
            const sec = document.getElementById(id);
            if (!sec) return;
            sec.classList.toggle('escondido');
            if (btn && btn.tagName === "BUTTON") {
                btn.innerText = sec.classList.contains('escondido') ? `Exibir ${nome}` : `Ocultar ${nome}`;
                if (nome === 'Criar Quest√£o') btn.innerText = sec.classList.contains('escondido') ? 'Criar Quest√£o' : 'Cancelar Cria√ß√£o';
            }
        }

        function iniciarQuiz() {
            document.getElementById('tela-menu').classList.add('escondido');
            document.getElementById('tela-quiz').classList.remove('escondido');
            indiceAtual = 0;
            mostrarPergunta();
        }

        function mostrarPergunta() {
            if (indiceAtual >= perguntas.length) return finalizarQuiz();
            
            clearInterval(cronometro);
            tempoRestante = 30;
            document.getElementById('timer').innerText = tempoRestante;
            
            const p = perguntas[indiceAtual];
            const textoPerguntaElement = document.getElementById('texto-pergunta');
            
            // Limpamos o conte√∫do anterior e verificamos se existe imagem
            // Se houver imagem (string Base64), criamos uma tag <img> antes do texto
            textoPerguntaElement.innerHTML = `
                ${p.imagem ? `<img src="${p.imagem}" class="img-pergunta" style="width:100%; max-height:250px; object-fit:contain; margin-bottom:15px; border-radius:8px; display:block;">` : ''}
                <span>${p.pergunta}</span>
            `;

            const area = document.getElementById('area-opcoes');
            area.innerHTML = "";
            
            p.opcoes.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'opcao';
                btn.innerText = opt;
                btn.style.background = "#3498db";
                btn.onclick = () => {
                    respostasUsuario[p.id] = opt;
                    indiceAtual++;
                    mostrarPergunta();
                };
                area.appendChild(btn);
            });

            cronometro = setInterval(() => {
                tempoRestante--;
                document.getElementById('timer').innerText = tempoRestante;
                if (tempoRestante <= 0) {
                    respostasUsuario[p.id] = "N/A";
                    indiceAtual++;
                    mostrarPergunta();
                }
            }, 1000);
        }

        async function finalizarQuiz() {
            clearInterval(cronometro);
            await fetch('/validar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuario: usuarioLogado, respostas: respostasUsuario })
            });
            location.reload();
        }

        async function enviarIdeia() {
            const pergunta = document.getElementById('sug-pergunta').value;
            const fotoInput = document.getElementById('input-foto-sug');
            const corretaSelec = document.querySelector('input[name="correta-sug"]:checked');

            if (!pergunta || !corretaSelec) {
                return alert("Por favor, preencha a pergunta e selecione a resposta correta.");
            }

            let imagemBase64 = null;

            // Se tiver foto, converte para Base64 antes de enviar
            if (fotoInput.files[0]) {
                imagemBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(fotoInput.files[0]);
                });
            }

            const novaSugestao = {
                pergunta: pergunta,
                imagem: imagemBase64,
                opcoes: [
                    document.getElementById('opt-sug-0').value,
                    document.getElementById('opt-sug-1').value,
                    document.getElementById('opt-sug-2').value,
                    document.getElementById('opt-sug-3').value,
                    document.getElementById('opt-sug-4').value
                ],
                correta: document.getElementById(`opt-sug-${corretaSelec.value}`).value
            };

            try {
                const response = await fetch('/salvar-ideia', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(novaSugestao)
                });

                if (response.ok) {
                    alert("Sugest√£o enviada com sucesso!");
                    location.reload();
                }
            } catch (error) {
                alert("Erro ao enviar. Verifique o servidor.");
            }
        }

        // ATUALIZE A FUN√á√ÉO DE ENVIAR SUGEST√ÉO (MATEUS)
        async function enviarIdeia() {
            const p = document.getElementById('sug-pergunta').value;
            const fotoFile = document.getElementById('input-foto').files[0];
            let imagemBase64 = null;

            if (fotoFile) imagemBase64 = await Utils.toBase64(fotoFile);

            const questao = {
                pergunta: p,
                imagem: imagemBase64, // Foto opcional inclusa aqui
                opcoes: [/* ... suas op√ß√µes ... */],
                correta: "..." 
            };
            
            await API.post('/salvar-ideia', questao);
            alert("Sugest√£o enviada!");
        }

        function renderBanco(questoes) {
            const container = document.getElementById('render-banco-geral');
            if (!container) return;

            container.innerHTML = questoes.map(q => {
                // Garantimos que o ID seja tratado como n√∫mero ou string conforme o banco
                const questaoId = q.id;

                return `
                    <div class="card-admin" style="border-left: 4px solid #f39c12; margin-bottom: 15px;">
                        ${q.imagem && q.imagem.trim() !== "" ? `
                            <div style="background: white; border-radius: 8px; padding: 8px; margin-bottom: 12px; text-align: center; border: 1px solid #ddd;">
                                <img src="${q.imagem}" 
                                    alt="Imagem da quest√£o"
                                    style="width: 100%; max-height: 180px; object-fit: contain; display: block; margin: 0 auto; cursor: pointer;"
                                    onclick="window.open(this.src)">
                                <small style="color: #666; font-size: 10px;">Clique para ampliar</small>
                            </div>
                        ` : `
                            <div style="background: #2c3e50; border-radius: 8px; padding: 10px; margin-bottom: 12px; text-align: center; border: 1px dashed #7f8c8d;">
                                <span style="color: #95a5a6; font-size: 12px;">Quest√£o sem imagem</span>
                            </div>
                        `}
                        
                        <div style="margin-bottom: 10px;">
                            <strong style="display: block; margin-bottom: 5px;">${q.pergunta}</strong>
                            <div style="margin-left: 5px; font-size: 13px; line-height: 1.6;">
                                ${q.opcoes.map(o => `
                                    <div style="${o === q.correta ? 'color: #2ecc71; font-weight: bold; background: rgba(46, 204, 113, 0.1); border-radius: 4px; padding-left: 5px;' : 'color: #ecf0f1;'}">
                                        ${o === q.correta ? '<span style="color: #2ecc71;">[X]</span>' : '[ ]'} ${o}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 5px; margin-top: 10px;">
                            <button onclick="ativarNoQuiz(${questaoId})" class="opcao" style="background: #27ae60; padding: 8px; font-weight: bold;">
                                üöÄ Ativar no Quiz Ativo
                            </button>
                            <button onclick="excluirDoBanco(${questaoId})" class="opcao" style="background: #e74c3c; padding: 6px; font-size: 11px; opacity: 0.9;">
                                üóëÔ∏è Excluir Permanentemente
                            </button>
                        </div>
                    </div>
                `;
            }).join('') || `<div style="text-align:center; padding: 20px; color: #bdc3c7;">üì≠ O banco de quest√µes est√° vazio.</div>`;
        }

        async function enviarSugestao() {
            const pergunta = document.getElementById('sug-pergunta').value;
            const fotoInput = document.getElementById('input-foto-sugestao');
            let imagemBase64 = null;

            if (fotoInput.files[0]) {
                imagemBase64 = await Utils.toBase64(fotoInput.files[0]);
            }

            const dados = {
                pergunta: pergunta,
                imagem: imagemBase64, // Agora enviando a string da foto
                opcoes: [/* capturar valores dos inputs */],
                correta: document.querySelector('input[name="correta-sug"]:checked').value
            };

            await API.post('/salvar-ideia', dados);
            alert("Sugest√£o enviada com sucesso!");
            location.reload();
        }

        // Local: Dentro do script no index.html
        function renderizarBanco(questoes) {
            const container = document.getElementById('render-banco-geral'); // Verifica o ID no teu HTML
            container.innerHTML = ""; // Limpa o container

            questoes.forEach(q => {
                // O PASSO 3 √â APLICADO AQUI:
                const card = `
                    <div class="card-admin">
                        ${q.imagem ? `<img src="${q.imagem}" style="width:100%; max-height:150px; object-fit:contain; border-radius:5px; margin-bottom:10px;">` : ''}
                        <p><strong>Quest√£o:</strong> ${q.pergunta}</p>
                        <div class="opcoes-preview">
                            ${q.opcoes.map(opt => `<div>[${opt === q.correta ? 'X' : ' '}] ${opt}</div>`).join('')}
                        </div>
                        <button onclick="ativarQuestao('${q.id}')" class="btn-ativar">Ativar no Quiz</button>
                        <button onclick="excluirPermanente('${q.id}')" class="btn-excluir">Excluir</button>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        async function criarQuestaoComFoto(tipo) {
            // 1. Captura dos elementos b√°sicos
            const pergunta = document.getElementById(tipo === 'sugestao' ? 'sug-pergunta' : 'admin-pergunta').value;
            const fotoInput = document.getElementById(tipo === 'sugestao' ? 'input-foto-sug' : 'input-foto-admin');
            
            if (!pergunta) return alert("Digite a pergunta!");

            let imagemBase64 = null;

            // 2. Processamento opcional da imagem
            if (fotoInput && fotoInput.files[0]) {
                try {
                    imagemBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(fotoInput.files[0]);
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = error => reject(error);
                    });
                } catch (err) {
                    console.error("Erro na imagem:", err);
                }
            }

            // 3. Montagem do objeto (Certifique-se que os campos batem com seu back-end)
            const novaQuestao = {
                pergunta: pergunta,
                imagem: imagemBase64, // Campo que o Quiz e o Banco v√£o ler
                opcoes: [/* pegue aqui seus inputs de op√ß√µes */],
                correta: "valor_da_correta"
            };

            // 4. Envio para a rota correta
            const rota = tipo === 'sugestao' ? '/salvar-ideia' : '/questoes/adicionar';
            
            try {
                const res = await fetch(rota, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(novaQuestao)
                });
                
                if (res.ok) {
                    alert("Sucesso!");
                    location.reload();
                }
            } catch (error) {
                alert("Erro ao conectar com o servidor.");
            }
        }

        function renderizarSugestoes(ideias) {
            const container = document.getElementById('container-sugestoes');
            container.innerHTML = ideias.map(i => `
                <div class="card-sugestao" style="background: #e8f5e9; border: 1px solid #2ecc71; padding: 10px; margin-bottom: 10px;">
                    ${i.imagem ? `<img src="${i.imagem}" style="width:100%; max-height:100px; object-fit:contain;">` : ''}
                    <p>${i.pergunta}</p>
                    <button onclick="aprovarSugestao('${i.id}')">Aprovar</button>
                    <button onclick="rejeitarSugestao('${i.id}')">Rejeitar</button>
                </div>
            `).join('');
        }

        // Faz a foto aparecer e mostra o bot√£o X
        function gerenciarPreview(input, imgId, btnId) {
            const preview = document.getElementById(imgId);
            const btnDel = document.getElementById(btnId);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    btnDel.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removerFoto(inputId, imgId, btnId) {
            document.getElementById(inputId).value = ""; 
            document.getElementById(imgId).style.display = 'none';
            document.getElementById(btnId).style.display = 'none';
        }

        async function login() {
            const usuarioInput = document.getElementById('user').value;
            const senhaInput = document.getElementById('pass').value;

            if (!usuarioInput || !senhaInput) {
                return alert("Por favor, preencha todos os campos.");
            }

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        usuario: usuarioInput, 
                        senha: senhaInput 
                    })
                });

                const dados = await response.json();

                if (dados.sucesso) {
                    // Guarda o nome do usu√°rio logado globalmente
                    usuarioLogado = usuarioInput.toLowerCase();
                    
                    // Esconde a tela de login e mostra o container principal
                    document.getElementById('view-login').classList.add('escondido');
                    
                    if (dados.tipo === 'admin') {
                        // Fun√ß√£o que voc√™ j√° deve ter ou precisa criar para montar o painel
                        abrirPainelAdmin(dados); 
                    } else {
                        // Fun√ß√£o para carregar o quiz para Pedro/Wagner
                        perguntas = dados.perguntas;
                        abrirMenuUser(dados);
                    }
                } else {
                    alert(dados.mensagem || "Usu√°rio ou senha incorretos.");
                }
            } catch (error) {
                console.error("Erro no login:", error);
                alert("N√£o foi poss√≠vel conectar ao servidor. Verifique se o server.js est√° rodando.");
            }
        }

        async function ativarNoQuiz(id) {
            if (!confirm("Deseja ativar esta quest√£o no Quiz atual?")) return;

            try {
                const res = await fetch('/questoes/ativar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });

                if (res.ok) {
                    alert("Quest√£o ativada com sucesso!");
                    
                    // Atualiza os dados para refletir que a quest√£o saiu do banco e foi para o quiz
                    await atualizarDadosInterface();
                    
                    // Atualiza a visualiza√ß√£o do banco para sumir a quest√£o de l√°
                    const btnBanco = document.querySelector("button[onclick*='toggleSecaoBanco']");
                    if (btnBanco) {
                        // For√ßa o refresh da lista do banco
                        const secBanco = document.getElementById('sec-banco-geral');
                        secBanco.classList.add('escondido'); // Fecha
                        toggleSecaoBanco('sec-banco-geral', btnBanco); // Abre carregando novos dados
                    }
                } else {
                    alert("Erro ao ativar quest√£o.");
                }
            } catch (err) {
                console.error("Erro ao ativar:", err);
            }
        }

        function voltarMenu() {
            // 1. Esconde todas as se√ß√µes de formul√°rios ou listas
            const secoes = [
                'sec-sugestao', 
                'sec-questoes', 
                'sec-banco-geral', 
                'sec-usuarios', 
                'sec-relatorios'
            ];
            
            secoes.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) elemento.classList.add('escondido');
            });

            // 2. Garante que o menu principal de bot√µes (container de op√ß√µes) esteja vis√≠vel
            const menuPrincipal = document.getElementById('menu-opcoes') || document.getElementById('area-admin');
            if (menuPrincipal) {
                menuPrincipal.classList.remove('escondido');
            }

            // 3. Reset de textos de bot√µes (caso algum toggle tenha mudado o texto)
            const btnQuestoes = document.querySelector("button[onclick*='toggleSecaoQuestoes']");
            if (btnQuestoes) btnQuestoes.innerText = "Exibir Quest√µes do Quiz";
        }
    </script>
</body>

</html>